(function(){var e,t;t=function(e,t){var n,r,i,s,o;o=$(e.node()).width(),s=$(e.node()).width(),r=window.devicePixelRatio||1,n=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,i=r/n;if(window.devicePixelRatio!==n)return e.attr("width",o*i).attr("height",s*i).style("width",o+"px").style("height",s+"px"),t.scale(i,i)},e=function(e,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C;i=d3.select("#recruit-map").append("canvas").attr("width",n.width).attr("height",n.height),o=i.node().getContext("2d"),p=d3.geo.path().projection(n.projection).context(o),v=d3.scale.linear().domain([1,2,3,4,5]).range([.1,.3,.5,.8,2]),t(i,o),o.beginPath(),p(n.nation),p(n.states),o.save(),o.lineWidth=1,o.strokeStyle="#333",o.stroke(),r=d3.nest().key(function(e){return e.gid}).rollup(function(e){return e[0]}).map(n.places),a=d3.nest().key(function(e){return e.place_gid}).rollup(function(e){return e.length}).entries(n.recruits),a.sort(function(e,t){return d3.descending(e.values,t.values)}),g=a.slice(0,15).map(function(e){return e.place=r[e.key],e}),T=n.recruits;for(w=0,S=T.length;w<S;w++)m=T[w],u=n.projection([m.lat,m.lon]),o.beginPath(),o.arc(u[0],u[1],v(m.stars),0,Math.PI*2,!1),o.fillStyle="rgba(255, 255, 255, 0.3)",o.shadowColor="rgba(255, 255, 255, 0.5)",o.fill();o.restore(),o.shadowBlur=0,o.globalCompositeOperation="normal",o.fillStyle="fff",o.lineWidth=.5,o.strokeStyle="333",o.font="12px Helvetica Neue",C=[];for(E=0,x=g.length;E<x;E++)s=g[E],d=s.place,N=n.projection([d.lon,d.lat]),y=N[0],b=N[1],f=""+d.name+": "+s.values,c=o.measureText(f),c.height=o.measureText("m").width,l=5,h=10,y+=l,b+=l,o.beginPath(),o.rect(y,b-c.height,c.width+h,c.height+h),o.fillStyle="rgba(31, 192, 30, 0.7)",o.fill(),o.beginPath(),o.fillStyle="rgba(255, 255, 255, 1)",o.arc(y-l,b-l,2,0,Math.PI*2,!1),o.fill(),o.beginPath(),o.fillStyle="#fff",o.fillText(f,y+h/2,b+h/2),C.push(o.fill());return C},$(document).on("data.loaded",e)}).call(this);